<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Site de Logs com Firebase - Sem GPS</title>

    <!-- Scripts do Firebase (versão compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-analytics-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore-compat.js"></script>
  </head>
  <body>
    <h1>Logs de Visita (Sem Permissão de GPS)</h1>
    <p>
      Esse site não pede permissão de GPS. Ele só obtém localização aproximada
      via IP (país, cidade).
    </p>

    <script>
      // ============== 1) CONFIGURAR O FIREBASE ============== //
      const firebaseConfig = {
        apiKey: "AIzaSyBDhQTXd2UT2Rhpj7ZDXkztgkFcj7cbndU",
        authDomain: "verbo-braga-jovens.firebaseapp.com",
        projectId: "verbo-braga-jovens",
        storageBucket: "verbo-braga-jovens.firebasestorage.app",
        messagingSenderId: "1047639862875",
        appId: "1:1047639862875:web:e2f36568c282db1188197e",
        measurementId: "G-HG530GGJRH"
      };

      // Inicializa o Firebase
      firebase.initializeApp(firebaseConfig);
      firebase.analytics();
      const db = firebase.firestore();

      // ============== 2) DETECTAR BROWSER E DISPOSITIVO ============== //
      const userAgent = navigator.userAgent || "Desconhecido";

      let deviceType = "Desktop";
      if (/Mobi|Android|iPhone|iPad|iPod/i.test(userAgent)) {
        deviceType = "Mobile";
      }

      let deviceBrand = "Desconhecido";
      if (/Samsung/i.test(userAgent)) {
        deviceBrand = "Samsung";
      } else if (/iPhone/i.test(userAgent)) {
        deviceBrand = "iPhone";
      } else if (/Huawei/i.test(userAgent)) {
        deviceBrand = "Huawei";
      } else if (/Xiaomi/i.test(userAgent)) {
        deviceBrand = "Xiaomi";
      } else if (/Macintosh/i.test(userAgent) && deviceType === "Desktop") {
        deviceBrand = "Apple (Mac)";
      } else if (/Windows/i.test(userAgent)) {
        deviceBrand = "Windows";
      }

      let browserName = "Desconhecido";
      if (userAgent.indexOf("Chrome") !== -1) {
        browserName = "Chrome";
      } else if (userAgent.indexOf("Safari") !== -1) {
        browserName = "Safari";
      } else if (userAgent.indexOf("Firefox") !== -1) {
        browserName = "Firefox";
      } else if (userAgent.indexOf("MSIE") !== -1 || userAgent.indexOf("Trident") !== -1) {
        browserName = "Internet Explorer";
      } else if (userAgent.indexOf("Edg") !== -1) {
        browserName = "Edge";
      }

      // ============== 3) PEGAR PAÍS E CIDADE (via IP) ============== //
      function getIpLocationData() {
        // Usamos a API pública ipapi.co. 
        // Lembrando que existem limites de uso ou necessidade de chave.
        return fetch("https://ipapi.co/json/")
          .then(response => response.json())
          .then(data => {
            const locationData = {
              ip: data.ip,
              city: data.city,
              region: data.region,
              country: data.country_name
            };
            return locationData;
          })
          .catch(err => {
            console.error("Erro ao buscar dados de IP:", err);
            return {
              ip: null,
              city: null,
              region: null,
              country: null
            };
          });
      }

      // ============== 4) REGISTRAR VISITA NO FIRESTORE ============== //
      async function registrarVisita() {
        // Aqui só pegamos info do IP (sem GPS do navegador)
        const ipLocationData = await getIpLocationData();
        const dataAtual = new Date();

        const visitaData = {
          data: dataAtual.toISOString(),
          ip: ipLocationData.ip,
          pais: ipLocationData.country,
          cidade: ipLocationData.city,
          regiao: ipLocationData.region,
          // latitude e longitude ficam null por não usar geolocation
          latitude: null,
          longitude: null,
          dispositivo: deviceType,
          marcaModelo: deviceBrand,
          navegador: browserName,
          userAgentCompleto: userAgent
        };

        db.collection("visitas")
          .add(visitaData)
          .then((docRef) => {
            console.log("Visita registrada com ID:", docRef.id);
          })
          .catch((error) => {
            console.error("Erro ao registrar visita:", error);
          });
      }

      // ============== 5) INICIAR O PROCESSO ============== //
      registrarVisita();
    </script>
  </body>
</html>
